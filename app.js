import{getLocalStorage}from"./localStorage.js";import"./menu.js";getLocalStorage("game_info"),document.documentElement.style.setProperty("--background-url",getLocalStorage("game_info")["custom-visual"]["custom-bg"].active?getLocalStorage("game_info")["custom-visual"]["custom-bg"].color:`url(${getLocalStorage("game_info").game_visual["visual-background"].src})`);const $arena=document.querySelector(".arena"),$scoreBoard=document.querySelector(".status"),KEY_CODE_SPACE=32,KEY_CODE_LEFT=37,KEY_CODE_A=65,KEY_CODE_UP=38,KEY_CODE_W=87,KEY_CODE_RIGHT=39,KEY_CODE_D=68,KEY_CODE_ENTER=13;let METEOR_HEIGHT,LASER_HEIGHT,BG_AUDIO,INT_SPAWN,PLAYER_ACCELERATION=getLocalStorage("game_info").player.acceleration,METEOR_ACCELERATION=60,LASER_ACCELERATION=60,LASER_COOLDOWN=3,ARENA_WIDTH=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--arena-width")),PLAYER_WIDTH=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--player-width")),METEOR_WIDTH=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--meteor-width")),LASER_WIDTH=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--laser-width")),BLAST_WIDTH=200,ARENA_HEIGHT=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--arena-height")),BLAST_HEIGHT=100,SCORE=0,DEFAULT_METEOR_SPAWN=1e3,TARGET_SCORE=getLocalStorage("game_info")["game-settings"]["max-score"],UPGRADE_LEVEL=getLocalStorage("game_info")["game-settings"]["upgrade-score"];const LEVEL_SKIP=UPGRADE_LEVEL;let myReq,timeStamp,WON_FLAG=!1,START_FLAG=!0,requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame,timesShoot=0;const GAME_STATE={lastTime:null,leftPressed:!1,rightPressed:!1,spacePressed:!1,playerCoolDown:0,playerX:0,playerY:0,meteors:[],lasers:[]};function getBracketAudio(e){const t=getLocalStorage("game_info")["game-audio"][e],a=new Audio;return a.src=t.src,a.volume=t.volume,a.loop=t.loop,a}function clamp(e,t,a){return e<t?t:e>a?a:e}function rectsIntersect(e,t){return!(t.left>e.right||t.right<e.left||t.top>e.bottom||t.bottom<e.top)}function setPositon(e,t,a){e.style.transform=`translate(${t}px, ${a}px)`}function createPlayer(){GAME_STATE.playerX=ARENA_WIDTH/2-PLAYER_WIDTH/2;let e=new Image;const t=getLocalStorage("game_info").game_visual["visual-player"].src;e.src=t,e.classList.add("player"),$arena.appendChild(e),PLAYER_WIDTH=e.getBoundingClientRect().width,setPositon(e,GAME_STATE.playerX,GAME_STATE.playerY)}function createMeteor(e,t){let a=new Image;const o=getLocalStorage("game_info").game_visual["visual-meteor"].src;a.src=o,a.classList.add("meteor");const n={x:e,y:t,element:a};GAME_STATE.meteors.push(n),$arena.appendChild(a),METEOR_WIDTH=a.getBoundingClientRect().width,METEOR_HEIGHT=a.getBoundingClientRect().height,setPositon(a,e,100)}function createLaser(e,t){e+=Math.abs(LASER_WIDTH-PLAYER_WIDTH)/2;let a=new Image;const o=getLocalStorage("game_info").game_visual["visual-laser"].src;a.src=o,a.classList.add("laser"),$arena.appendChild(a),LASER_WIDTH=a.getBoundingClientRect().width,LASER_HEIGHT=a.getBoundingClientRect().height;const n={x:e,y:t,element:a};GAME_STATE.lasers.push(n),setPositon(a,e,t)}function createTemplate(e,t,a){const o=document.createElement("div");o.classList.add("template"),o.style.height=`${e}px`,o.style.width=`${e}px`,o.style.backgroundColor="blue",o.style.position="absolute",$arena.appendChild(o),template=document.querySelector(".template")}function createBlast(e,t){t-=BLAST_HEIGHT/2,e-=Math.abs(PLAYER_WIDTH-BLAST_WIDTH)/2;const a=document.createElement("video");a.src="./videos/blue-blast.mp4",a.classList.add("blast"),a.autoplay=!0,setPositon(a,e,t),a.onended=(()=>{a.remove()}),$arena.appendChild(a),BLAST_WIDTH=a.getBoundingClientRect().width,BLAST_HEIGHT=a.getBoundingClientRect().height}function updateLaser(e){const t=GAME_STATE.lasers;for(let a=0;a<t.length;a++){const o=t[a];o.y-=e*LASER_ACCELERATION,o.y<0&&addShadowAnimationEnd(o),setPositon(o.element,o.x,o.y);const n=o.element.getBoundingClientRect(),E=GAME_STATE.meteors;for(let e=0;e<E.length;e++){const t=E[e];if(!t.isDead&&rectsIntersect(n,t.element.getBoundingClientRect())){getBracketAudio("blast-audio").play(),SCORE++,createBlast(o.x,o.y),destroyElement(t),destroyElement(o),updateScore();break}}}GAME_STATE.lasers=GAME_STATE.lasers.filter(e=>!e.isDead)}function updateMeteor(e){const t=GAME_STATE.meteors;for(let a=0;a<t.length;a++){const o=t[a];o.y+=e*METEOR_ACCELERATION,o.y>ARENA_HEIGHT-o.element.getBoundingClientRect().height&&addShadowAnimationEnd(o),setPositon(o.element,o.x,o.y),rectsIntersect(o.element.getBoundingClientRect(),document.querySelector(".player").getBoundingClientRect())&&(WON_FLAG||conclusion("defeated"))}GAME_STATE.meteors=GAME_STATE.meteors.filter(e=>!e.isDead)}function addShadowAnimationEnd(e){e.element.classList.add("impact"),setInterval(()=>{destroyElement(e)},1e3)}function updatePlayer(e){const t=document.querySelector(".player");GAME_STATE.leftPressed&&(GAME_STATE.playerX-=e*PLAYER_ACCELERATION),GAME_STATE.rightPressed&&(GAME_STATE.playerX+=e*PLAYER_ACCELERATION),GAME_STATE.playerX=clamp(GAME_STATE.playerX,0,ARENA_WIDTH-PLAYER_WIDTH),GAME_STATE.playerY=ARENA_HEIGHT-PLAYER_WIDTH-20,GAME_STATE.spacePressed&&GAME_STATE.playerCoolDown<=0&&(timesShoot++,createLaser(GAME_STATE.playerX,GAME_STATE.playerY),GAME_STATE.playerCoolDown=LASER_COOLDOWN,getBracketAudio("shoot-audio").play()),GAME_STATE.playerCoolDown>0&&(GAME_STATE.playerCoolDown-=e),setPositon(t,GAME_STATE.playerX,GAME_STATE.playerY)}function update(){const e=Date.now(),t=(e-GAME_STATE.lastTime)/100;updateLaser(t),updateMeteor(t),updatePlayer(t),GAME_STATE.lastTime=e,myReq=requestAnimationFrame(update)}function destroyElement(e){e.element.remove(),e.isDead=!0;randomNumber(0,ARENA_WIDTH-METEOR_WIDTH)}function randomNumber(e,t){return Math.random()*(t-e)+e}function meteorSpawn(e,t=METEOR_ACCELERATION){clearInterval(INT_SPAWN),METEOR_ACCELERATION=t,INT_SPAWN=setInterval(()=>{createMeteor(randomNumber(0,ARENA_WIDTH-METEOR_WIDTH),0)},e)}function laserSpawn(e,t=LASER_ACCELERATION){LASER_COOLDOWN=e}function onKeyDown(e){e.keyCode!=KEY_CODE_LEFT&&e.keyCode!=KEY_CODE_A||(GAME_STATE.leftPressed=!0),e.keyCode!=KEY_CODE_RIGHT&&e.keyCode!=KEY_CODE_D||(GAME_STATE.rightPressed=!0),e.keyCode==KEY_CODE_SPACE&&(GAME_STATE.spacePressed=!0)}function onKeyUp(e){e.keyCode!=KEY_CODE_LEFT&&e.keyCode!=KEY_CODE_A||(GAME_STATE.leftPressed=!1),e.keyCode!=KEY_CODE_RIGHT&&e.keyCode!=KEY_CODE_D||(GAME_STATE.rightPressed=!1),e.keyCode==KEY_CODE_SPACE&&(GAME_STATE.spacePressed=!1)}function showScoreBoard(){$scoreBoard.innerHTML=`\n   <span class="scoreStatus">SCORE:${SCORE} ðŸ”¥</span>\n   <span class="maxScoreStatus">TARGETSCORE:${TARGET_SCORE} ðŸ˜¬</span>\n   <span class="percentageStatus">WINNING:${Math.round(SCORE/TARGET_SCORE*100)}% ðŸ˜³</span>\n   \n   `}async function updateScore(){await showScoreBoard(),SCORE==TARGET_SCORE&&(WON_FLAG=!0,conclusion("won")),SCORE==UPGRADE_LEVEL&&(UPGRADE_LEVEL+=LEVEL_SKIP,meteorSpawn(DEFAULT_METEOR_SPAWN-=DEFAULT_METEOR_SPAWN/2,METEOR_ACCELERATION*=1.25))}async function conclusion(e){await showScoreBoard();const t=await getLocalStorage("game_info");let a=t.gamePlay_info.length;const o={id:a,"date-initialized":Date.now(),"date-finished":timeStamp,"final-score":SCORE,"times-shoot":timesShoot,status:e,"player-acceleration":PLAYER_ACCELERATION,"target-score":TARGET_SCORE,"upgrade-level":UPGRADE_LEVEL};await t.gamePlay_info.push(o),await localStorage.setItem("game_info",JSON.stringify(t)),await BG_AUDIO.pause(),await alert(`${"defeated"==e?"You have been defeated!"+a:"You won!"} Score: ${SCORE} `),window.location.reload()}function INIT(){PLAYER_ACCELERATION=getLocalStorage("game_info").player.acceleration,TARGET_SCORE=getLocalStorage("game_info")["game-settings"]["max-score"],UPGRADE_LEVEL=getLocalStorage("game_info")["game-settings"]["upgrade-score"],$arena.innerHTML="",GAME_STATE.lastTime=Date.now(),timeStamp=Date.now(),$arena.classList.remove("borderChangeColor"),START_FLAG=!1,document.body.classList.remove("gameNotStarted"),(BG_AUDIO=getBracketAudio("bg-audio")).play(),createPlayer(),meteorSpawn(DEFAULT_METEOR_SPAWN),showScoreBoard(),myReq=requestAnimationFrame(update),window.addEventListener("keyup",onKeyUp),window.addEventListener("keydown",onKeyDown)}window.addEventListener("load",function(){const e=document.querySelector(".loader");e.classList.add("loaded"),e.addEventListener("animationend",()=>{e.remove(),window.addEventListener("keydown",function(e){START_FLAG&&(13!=e.keyCode&&e.keyCode!=KEY_CODE_SPACE||INIT())},!1)})});export{INIT};